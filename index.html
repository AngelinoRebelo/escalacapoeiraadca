<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Portaria, Direção e Preletor</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilos personalizados para a tabela */
        /* COR NEUTRA: Tonalidade escura para o cabeçalho de seção (o novo cabeçalho repetido) */
        .table-header {
            background-color: #374151; /* Dark Gray/Indigo */
            color: white;
            font-weight: 600;
        }
        /* COR NEUTRA: Cor de Fundo do Divisor de Semana */
        .week-divider {
            background-color: #F0F4FF; /* Very Light Blue/Indigo */
            font-weight: 700;
            color: #1E40AF; /* Dark Blue for contrast */
            text-align: center;
        }
        /* Estilo para a célula de culto (serviço) */
        .culto-cell {
            font-weight: 500;
            text-transform: uppercase;
        }
        
        /* CORES DE FUNDO ALTERNADAS E ESPECIAIS (NEUTRAS) */
        /* Linha com fundo branco/off-white */
        .culto-color-light-grey {
            background-color: #F9FAFB; 
        }
        /* Linha com fundo azul muito claro e neutro */
        .culto-color-light-blue {
            background-color: #F0F9FF;
        }
        /* Destaque para CULTO DE MISSÕES (Tonalidade de índigo suave) */
        .culto-missoes {
            background-color: #E0E7FF; /* Indigo-200 */
        }
        /* Garante que o texto dentro da linha escura fique escuro */
        .culto-missoes td {
            color: #1F2937 !important; 
        }
        
        /* Remove o cabeçalho fixo original */
        #main-table-header {
            display: none;
        }

        /* Estilo para os SELECTs inline */
        .inline-select {
            appearance: none; /* Remove seta padrão */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%236b7280%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 0.8rem;
            padding-right: 1.5rem; /* Espaço para a seta */
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            height: 1.75rem; /* Altura padrão */
            width: 100%;
            min-width: 120px;
            max-width: 200px;
            cursor: pointer;
        }
        
        /* Estilo para o botão Salvar Escala (Novo) */
        #save-button {
            background-color: #10B981; /* Green-500 */
            color: white;
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s, transform 0.1s;
        }
        #save-button:hover {
            background-color: #059669; /* Green-600 */
            transform: scale(1.02);
        }

        /* Estilo para o botão/ícone sutil de adição */
        #subtle-add-btn {
            background-color: #6366F1; /* Indigo-500 */
            color: white;
            padding: 8px 12px;
            border-radius: 9999px; /* Full rounded */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, transform 0.1s;
        }
        #subtle-add-btn:hover {
            background-color: #4F46E5; /* Indigo-600 */
            transform: scale(1.05);
        }
        /* Estilo para o botão de Logar/Sair */
        #auth-button {
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #auth-button.logged-out {
            background-color: #10B981; /* Green-500 */
            color: white;
        }
        #auth-button.logged-out:hover {
            background-color: #059669; /* Green-600 */
        }
        #auth-button.logged-in {
            background-color: #EF4444; /* Red-500 */
            color: white;
        }
        #auth-button.logged-in:hover {
            background-color: #DC2626; /* Red-600 */
        }
        
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Título Principal e Botão de Login/Logout -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Escala dos Cultos</h1>
                <p id="auth-status" class="text-sm text-gray-600">Carregando autenticação...</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Status de Salvamento (Novo) -->
                <span id="save-status" class="text-sm font-semibold text-green-600 hidden">Salvo!</span>

                <!-- Botão de Salvar Escala (Novo) -->
                <button id="save-button" onclick="saveAllChanges()" class="hidden">
                    Salvar Escala
                </button>
                
                <!-- Ícone sutil para Adicionar Item (Apenas visível se logado) -->
                <button id="subtle-add-btn" onclick="openModal()" title="Adicionar Novo Item na Escala (Data, Dia, Culto)" class="hidden">
                    <!-- Ícone Plus (Lucide-react SVG inline) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M5 12h14"/>
                        <path d="M12 5v14"/>
                    </svg>
                </button>

                <!-- Botão de Logar/Sair -->
                <button id="auth-button" class="logged-out" onclick="handleAuthClick()">
                    Logar para Editar
                </button>
            </div>
        </header>

        <!-- Controles, Filtros -->
        <div class="flex justify-start items-center mb-6 space-x-3">
            <!-- Seletor de Mês -->
            <select id="month-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
            <!-- Seletor de Ano -->
            <select id="year-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
        </div>

        <!-- Tabela de Escala (Responsiva) -->
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- Cabeçalho Vazio (Mantido para a estrutura da tabela, mas invisível) -->
                    <thead id="main-table-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider rounded-tl-xl">Data</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Dia</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Culto</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Portaria</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Direção</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Preletor</th>
                            <th class="px-4 py-3 text-center text-xs uppercase tracking-wider rounded-tr-xl">Ações</th>
                        </tr>
                    </thead>
                    <!-- Corpo da Tabela (Preenchido via JavaScript) -->
                    <tbody id="schedule-body" class="bg-white divide-y divide-gray-100">
                        <!-- Linhas da escala serão injetadas aqui -->
                        <tr>
                            <td colspan="7" class="py-12 text-center text-gray-500">
                                <span class="animate-pulse">Carregando escala em tempo real...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="no-data-message" class="hidden p-6 text-center text-gray-500">
                Nenhum item na escala. Logue como Editor para adicionar novas datas.
            </div>
        </div>
        
        <!-- Informações do Usuário/App (Apenas para debug em desenvolvimento, mas necessário para Firestore) -->
        <footer class="mt-8 text-xs text-gray-500 p-4 bg-gray-100 rounded-lg">
            <p><strong>App ID:</strong> <span id="display-app-id"></span></p>
            <p><strong>User ID:</strong> <span id="display-user-id"></span></p>
            <p>Este app usa o Firestore para colaboração em tempo real.</p>
        </footer>
    </div>
    
    <!-- Modal de Login -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <header class="bg-indigo-600 p-4 text-white">
                <h2 class="text-2xl font-bold">Acesso de Editor</h2>
            </header>
            
            <form id="login-form" class="p-6 space-y-4">
                <p id="login-error" class="text-sm text-red-600 hidden">Credenciais inválidas. Tente novamente.</p>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" required placeholder="Seu Email"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" required placeholder="Sua Senha"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="flex justify-between pt-4">
                    <button type="button" onclick="closeLoginModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Logar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal (Formulário) - Usado APENAS para Data, Dia e Culto -->
    <div id="entry-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <!-- Título do Modal -->
            <header class="bg-indigo-600 p-4 text-white">
                <h2 id="modal-title" class="text-2xl font-bold">Adicionar Novo Item</h2>
            </header>
            
            <!-- Formulário -->
            <form id="entry-form" class="p-6 space-y-4">
                <input type="hidden" id="entry-id">
                
                <!-- Data -->
                <div>
                    <label for="date-input" class="block text-sm font-medium text-gray-700">Data (DD/MM/AAAA)</label>
                    <input type="text" id="date-input" placeholder="Ex: 03/10/2025" required pattern="\d{2}/\d{2}/\d{4}"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Formato obrigatório: DD/MM/AAAA</p>
                </div>
                
                <!-- Dia da Semana -->
                <div>
                    <label for="day-input" class="block text-sm font-medium text-gray-700">Dia da Semana</label>
                    <select id="day-input" required
                            class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="DOMINGO">DOMINGO</option>
                        <option value="SEGUNDA-FEIRA">SEGUNDA-FEIRA</option>
                        <option value="TERÇA-FEIRA">TERÇA-FEIRA</option>
                        <option value="QUARTA-FEIRA">QUARTA-FEIRA</option>
                        <option value="QUINTA-FEIRA">QUINTA-FEIRA</option>
                        <option value="SEXTA-FEIRA">SEXTA-FEIRA</option>
                        <option value="SÁBADO">SÁBADO</option>
                    </select>
                </div>

                <!-- Culto -->
                <div>
                    <label for="culto-input" class="block text-sm font-medium text-gray-700">Culto (Serviço)</label>
                    <input type="text" id="culto-input" placeholder="Ex: DOUTRINA, LOUVOR E ADORAÇÃO" required
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- Campos de Nomes (Escondidos, pois a edição é inline na tabela) -->
                <input type="hidden" id="portaria-input" value="À DEFINIR">
                <input type="hidden" id="direcao-input" value="À DEFINIR">
                <input type="hidden" id="preletor-input" value="À DEFINIR">

                <!-- Botões de Ação -->
                <div class="flex justify-between pt-4">
                    <button type="button" onclick="closeModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" id="save-button"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Salvar Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação (Substitui alert/confirm) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <header class="bg-red-600 p-4 text-white">
                <h2 class="text-xl font-bold">Confirmação de Exclusão</h2>
            </header>
            <div class="p-6">
                <p id="confirm-message" class="text-gray-700 mb-6">Tem certeza de que deseja excluir este item da escala?</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideConfirmModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Não, Cancelar
                    </button>
                    <button type="button" id="confirm-delete-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Sim, Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Imports do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais 
        let app, db, auth;
        let userId = '';
        let isEditor = false; // Controla a permissão de edição
        // Variáveis de filtro
        let currentMonth = new Date().getMonth() + 1; // 1-12
        let currentYear = new Date().getFullYear();
        
        // --- LISTA DE NOMES PREDEFINIDOS ---
        const PREDEFINED_NAMES = [
            "PR. GABRIEL", "PRB. LEANDRO", "MISS. KELLY", "MISS.ANA", 
            "MISS.LORRANE", "MISS.ESTER", "DCa.SIMONE", "DCa. RAQUEL", 
            "DCa. ROSA", "OB. CLEMILTON", "OB. MARCOS", "OB. JANETE", 
            "OB. ANA ROCHA", "IR. GABRIEL", "IR. VITÓRIA", "DCa. CRISTIANE"
        ].sort(); 
        
        // Define a configuração do Firebase
        const FIREBASE_CONFIG_OBJ = {
            apiKey: "AIzaSyAIVZC5Q8lfcMPCiv1oQzFm1oCajNB76c8",
            authDomain: "escala-adca-capoeira.firebaseapp.com",
            projectId: "escala-adca-capoeira",
            storageBucket: "escala-adca-capoeira.firebasestorage.app",
            messagingSenderId: "1015575781500",
            appId: "1:1015575781500:web:1c483c568b98dfd5cd29f9"
        };
        
        // Prioriza a variável de ambiente, mas usa a estática se não estiver presente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_OBJ;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-escala-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // URL da coleção pública (Obrigatório usar esta estrutura)
        const getCollectionPath = () => `/artifacts/${appId}/public/data/escala`;
        
        // Array de meses em português (1-indexado)
        const MONTH_NAMES = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        
        // Array de nomes dos dias da semana (0=Domingo)
        const DAY_NAMES = ["DOMINGO", "SEGUNDA-FEIRA", "TERÇA-FEIRA", "QUARTA-FEIRA", "QUINTA-FEIRA", "SEXTA-FEIRA", "SÁBADO"];


        // Função para converter data DD/MM/AAAA em objeto Date para comparação e ordenação
        const parseDate = (dateString) => {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const year = parseInt(parts[2], 10);
                const month = parseInt(parts[1], 10) - 1; 
                const day = parseInt(parts[0], 10);
                return new Date(year, month, day);
            }
            return new Date(0); 
        };
        
        // Função para obter o nome da semana/bloco (usada para o divisor de grupo)
        const getBlockName = (index) => {
            const weekNumber = Math.floor(index / 3) + 1;
            const weekNames = ["PRIMEIRA", "SEGUNDA", "TERCEIRA", "QUARTA", "QUINTA", "SEXTA", "SÉTIMA", "OITAVA"];
            
            const monthName = MONTH_NAMES[currentMonth - 1].toUpperCase(); 
            
            if (weekNumber <= weekNames.length) {
                return `${weekNames[weekNumber - 1]} SEMANA DE ${monthName} DE ${currentYear}`;
            }
            return `BLOCO DE SERVIÇOS ${weekNumber}`;
        }
        
        // Atualiza os seletores de mês e ano e define os listeners
        function updateFiltersUI() {
            const monthSelect = document.getElementById('month-filter');
            const yearSelect = document.getElementById('year-filter');
            
            // Popula os meses
            monthSelect.innerHTML = MONTH_NAMES.map((name, index) => {
                const monthValue = index + 1;
                const isSelected = monthValue === currentMonth;
                return `<option value="${monthValue}" ${isSelected ? 'selected' : ''}>${name}</option>`;
            }).join('');
            
            // Popula os anos: de 1 ano antes até 2 anos depois
            const startYear = new Date().getFullYear() - 1; 
            const endYear = new Date().getFullYear() + 2;   
            
            yearSelect.innerHTML = '';
            for (let y = startYear; y <= endYear; y++) {
                const isSelected = y === currentYear;
                yearSelect.innerHTML += `<option value="${y}" ${isSelected ? 'selected' : ''}>${y}</option>`;
            }
            
            // Event Listeners
            monthSelect.onchange = (e) => {
                currentMonth = parseInt(e.target.value, 10);
                loadSchedule(); 
            };

            yearSelect.onchange = (e) => {
                currentYear = parseInt(e.target.value, 10);
                loadSchedule(); 
            };
        }


        /**
         * Gera entradas de placeholder para todas as semanas do mês seleccionado.
         */
        const generatePlaceholderItems = (month, year) => {
            const targetMonth = month - 1; // 0-indexado
            const targetYear = year;
            
            let currentDate = new Date(targetYear, targetMonth, 1); 
            // Avança para o primeiro Domingo do mês (ou antes, se o mês começar no meio da semana)
            currentDate.setDate(currentDate.getDate() + (0 - currentDate.getDay() + 7) % 7); 
            
            const daysInBlock = [0, 3, 5]; // Domingo, Quarta, Sexta
            const cultosInBlock = ["LOUVOR E ADORAÇÃO", "DOUTRINA", "LIBERTAÇÃO"];
            const placeholderItems = [];

            // Adiciona a lógica para garantir que começamos no primeiro domingo do mês ou antes
            let firstDayOfMonth = new Date(targetYear, targetMonth, 1);
            let dayOffset = (0 - firstDayOfMonth.getDay() + 7) % 7; 
            let firstSunday = new Date(targetYear, targetMonth, 1 + dayOffset);

            currentDate = firstSunday; // Começa a iteração no primeiro Domingo relevante

            // Itera pelas semanas
            let maxIterations = 6; 
            for(let week = 0; week < maxIterations; week++) {
                let foundItemInMonth = false;
                let blockItems = [];
                
                // Itera pelos 3 cultos na semana (D, Q, S)
                for (let i = 0; i < 3; i++) {
                    const blockDate = new Date(currentDate);
                    blockDate.setDate(currentDate.getDate() + daysInBlock[i]);
                    
                    // Verifica se a data pertence ao mês selecionado.
                    if (blockDate.getMonth() !== targetMonth) {
                        continue;
                    }
                    
                    foundItemInMonth = true;
                    
                    const dayString = DAY_NAMES[blockDate.getDay()];
                    let cultoString = cultosInBlock[i];
                    
                    // Aplica destaques específicos apenas para o visual, se necessário
                    const currentBlockIndex = Math.floor(placeholderItems.length / 3);
                    if (currentBlockIndex === 1 && i === 0) { 
                        cultoString = "SANTA CEIA";
                    } else if (currentBlockIndex === 2 && i === 1) { 
                        cultoString = "CULTO DE MISSÕES";
                    }

                    blockItems.push({
                        id: null, 
                        date: `${String(blockDate.getDate()).padStart(2, '0')}/${String(blockDate.getMonth() + 1).padStart(2, '0')}/${blockDate.getFullYear()}`,
                        day: dayString,
                        culto: cultoString,
                        portaria: "À DEFINIR",
                        direcao: "À DEFINIR",
                        preletor: "À DEFINIR",
                        timestamp: blockDate.getTime()
                    });
                }
                
                placeholderItems.push(...blockItems);

                // Avança para o próximo domingo
                currentDate.setDate(currentDate.getDate() + 7); 
                
                // Se o próximo domingo já estiver fora do mês, para a iteração
                if (currentDate.getMonth() !== targetMonth && currentDate.getDate() < 7) {
                    break;
                }
            }

            return placeholderItems;
        };
        
        // --- FUNÇÕES DE AUTENTICAÇÃO E UI DE EDITOR ---

        function updateAuthUI() {
            const authButton = document.getElementById('auth-button');
            const subtleAddBtn = document.getElementById('subtle-add-btn');
            const saveButton = document.getElementById('save-button');
            
            if (isEditor) {
                // Usuário logado como editor
                authButton.textContent = 'Sair';
                authButton.classList.remove('logged-out');
                authButton.classList.add('logged-in');
                subtleAddBtn.classList.remove('hidden'); // Mostra o botão de adicionar
                saveButton.classList.remove('hidden'); // Mostra o botão de salvar
                document.getElementById('auth-status').textContent = `Editor logado: ${auth.currentUser.email}`;
            } else {
                // Usuário não logado como editor
                authButton.textContent = 'Logar para Editar';
                authButton.classList.remove('logged-in');
                authButton.classList.add('logged-out');
                subtleAddBtn.classList.add('hidden'); // Esconde o botão de adicionar
                saveButton.classList.add('hidden'); // Esconde o botão de salvar
                document.getElementById('auth-status').textContent = `Modo visualização. Faça login para editar.`;
            }
            // Chama renderTable para re-habilitar/desabilitar os SELECTs e botões de acordo com o novo estado de login
            loadSchedule();
        }
        
        window.openLoginModal = function() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
            document.getElementById('login-error').classList.add('hidden');
        }

        window.closeLoginModal = function() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('flex');
            document.body.style.overflow = '';
            document.getElementById('login-form').reset();
        }

        window.handleAuthClick = async function() {
            if (isEditor) {
                // Se estiver logado, faz logout e reinicia o estado
                try {
                    await signOut(auth);
                    // O onAuthStateChanged tratará do resto
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                }
            } else {
                // Se não estiver logado, abre o modal de login
                openLoginModal();
            }
        }
        
        // FUNÇÃO DE LOGIN MODIFICADA PARA USAR AUTENTICAÇÃO REAL DO FIREBASE
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDisplay = document.getElementById('login-error');
            
            errorDisplay.classList.add('hidden');
            
            try {
                // Tenta logar com as credenciais cadastradas no Firebase
                await signInWithEmailAndPassword(auth, email, password);
                
                // Se bem-sucedido, o onAuthStateChanged irá definir isEditor = true
                closeLoginModal();
                
            } catch (error) {
                console.error("Erro de login:", error);
                // Exibe a mensagem de erro formatada
                let errorMessage = "Erro ao tentar logar. Verifique o email e senha.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                     errorMessage = "Email ou senha incorretos.";
                } else if (error.code === 'auth/invalid-email') {
                     errorMessage = "Formato de email inválido.";
                } else if (error.code === 'auth/operation-not-allowed') {
                     // ERRO CORRIGIDO AQUI: Mensagem clara para o usuário sobre a necessidade de ativar o provedor
                     errorMessage = "A autenticação por Email/Senha não está ativada no seu projeto Firebase. Ative-a no Console do Firebase (Autenticação -> Provedores).";
                }
                errorDisplay.textContent = errorMessage;
                errorDisplay.classList.remove('hidden');
            }
        });

        // --- FUNÇÃO DO NOVO BOTÃO SALVAR ESCALA ---
        window.saveAllChanges = function() {
            if (!isEditor) return;
            
            const saveButton = document.getElementById('save-button');
            const saveStatus = document.getElementById('save-status');

            saveButton.textContent = 'Salvando...';
            saveButton.disabled = true;
            saveStatus.classList.add('hidden');

            // O Firestore já salva em tempo real (inline e no modal). 
            // Este timeout é apenas para dar feedback visual de que a ação foi concluída.
            setTimeout(() => {
                saveButton.textContent = 'Salvar Escala';
                saveButton.disabled = false;
                
                saveStatus.textContent = 'Salvo!';
                saveStatus.classList.remove('hidden');
                
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                }, 3000); 
                
                console.log("Escala salva (Real-time). Botão acionado para confirmação do usuário.");
            }, 500);
        }

        // --- INICIALIZAÇÃO E OBSERVAÇÃO ---
        async function setupFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config não encontrado. A persistência não funcionará.");
                document.getElementById('auth-status').textContent = "ERRO: Configuração do Firebase ausente.";
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listener de estado de autenticação
                onAuthStateChanged(auth, async (user) => {
                    // Resetamos o estado do editor
                    isEditor = false;
                    
                    // 1. Tenta logar anonimamente ou com token inicial (para visualização)
                    if (!user) {
                        if (initialAuthToken) {
                            // Tenta logar com o token fornecido
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                user = auth.currentUser;
                            } catch (error) {
                                console.warn("Falha ao usar token customizado. Tentando login anônimo.", error);
                                await signInAnonymously(auth);
                                user = auth.currentUser;
                            }
                        } else {
                            // Tenta anonimamente
                            await signInAnonymously(auth);
                            user = auth.currentUser;
                        }
                    }
                    
                    // 2. Verifica se o usuário logado é um editor (logado com email/senha)
                    if (user && user.providerData.some(p => p.providerId === 'password')) {
                         isEditor = true; 
                    }
                    
                    userId = user?.uid || crypto.randomUUID();
                    document.getElementById('display-app-id').textContent = appId;
                    document.getElementById('display-user-id').textContent = userId;
                    
                    // Atualiza a UI com o estado inicial (visualizador ou editor)
                    updateAuthUI();
                    
                    // Só inicia a escuta do Firestore após o estado inicial ser definido
                    if (!document.getElementById('month-filter').options.length) {
                        updateFiltersUI();
                        loadSchedule();
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                document.getElementById('auth-status').textContent = `ERRO: Falha na autenticação.`;
            }
        }

        function loadSchedule() {
            if (!db) return;
            const scaleRef = collection(db, getCollectionPath());
            const q = query(scaleRef); 

            onSnapshot(q, (snapshot) => {
                let schedule = [];
                snapshot.forEach(doc => {
                    schedule.push({ id: doc.id, ...doc.data() });
                });

                // 1. FILTRAGEM
                schedule = schedule.filter(item => {
                    const parts = item.date.split('/');
                    if (parts.length === 3) {
                        const itemMonth = parseInt(parts[1], 10);
                        const itemYear = parseInt(parts[2], 10);
                        return itemMonth === currentMonth && itemYear === currentYear;
                    }
                    return false; 
                });

                // 2. ORDENAÇÃO LOCAL
                schedule.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    if (dateA - dateB !== 0) {
                        return dateA - dateB;
                    }
                    return a.timestamp - b.timestamp;
                });
                
                // 3. PLACEHOLDERS: Se a lista filtrada estiver vazia, gera placeholders
                const finalSchedule = schedule.length === 0 ? generatePlaceholderItems(currentMonth, currentYear) : schedule;

                renderTable(finalSchedule, schedule.length === 0);
            }, (error) => {
                console.error("Erro ao receber dados da escala:", error);
                document.getElementById('schedule-body').innerHTML = `
                    <tr><td colspan="7" class="py-4 text-center text-red-500">
                        Erro ao carregar os dados: ${error.message}
                    </td></tr>`;
            });
        }

        /**
         * Envia uma atualização de campo (Portaria, Direção, Preletor) diretamente para o Firestore.
         */
        window.updateFieldInline = async function (docId, field, value) {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor para modificar.");
                loadSchedule(); // Restaura o estado para o valor do BD
                return;
            }
            if (docId === 'null') {
                console.warn("Item não salvo no Firestore. Por favor, clique em 'Preencher Data' para salvar primeiro.");
                // Nenhuma ação adicional aqui, a tabela será recarregada via onSnapshot
                // se for um placeholder, a mudança de valor é local e será perdida,
                // mas a intenção de manter o campo habilitado é cumprida.
                return;
            }

            const docRef = doc(db, getCollectionPath(), docId);
            const updateData = {
                [field]: value,
                // Usa o email do usuário logado para o rastreio
                lastModifiedBy: auth.currentUser?.email || 'Editor (Email/Senha)',
                timestamp: new Date().getTime() 
            };

            try {
                await setDoc(docRef, updateData, { merge: true });
                console.log(`Documento ${docId} campo ${field} atualizado para ${value}.`);
            } catch (error) {
                console.error("Erro ao atualizar o documento inline:", error);
                loadSchedule(); 
            }
        }
        
        /**
         * Cria o elemento SELECT para edição inline.
         */
        function createNameSelect(docId, fieldName, currentValue) {
            // Desabilita APENAS se o usuário NÃO for editor.
            const isDisabled = !isEditor; 
            
            let options = ``;
            const isADefinirSelected = currentValue === 'À DEFINIR' || !currentValue;
            // Adiciona a opção "À DEFINIR"
            options += `<option value="À DEFINIR" ${isADefinirSelected ? 'selected' : ''}>À DEFINIR</option>`;
            
            // Adiciona as opções de nomes predefinidos
            PREDEFINED_NAMES.forEach(name => {
                const isSelected = name === currentValue ? 'selected' : '';
                options += `<option value="${name}" ${isSelected}>${name}</option>`;
            });

            return `
                <select 
                    class="inline-select ${isDisabled ? 'opacity-75 bg-gray-100 cursor-default' : ''}"
                    onchange="updateFieldInline('${docId}', '${fieldName}', this.value)"
                    ${isDisabled ? 'disabled' : ''}
                >
                    ${options}
                </select>
            `;
        }

        function getRowClass(culto, index) {
            const upperCulto = culto.toUpperCase();
            
            if (upperCulto.includes('CULTO DE MISSÕES')) {
                return 'culto-missoes';
            }
            
            const blockIndex = index % 3; 

            if (blockIndex === 0) {
                return 'culto-color-light-grey';
            } else if (blockIndex === 1) {
                return 'culto-color-light-blue';
            } else {
                 return 'culto-color-light-grey';
            }
        }

        function createHeaderRow() {
             const headerRow = document.createElement('tr');
             headerRow.className = 'table-header';
             headerRow.innerHTML = `
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Data</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Dia</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Culto</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Portaria</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Direção</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Preletor</th>
                <th class="px-4 py-3 text-center text-xs uppercase tracking-wider">Ações</th>
            `;
            return headerRow;
        }


        // Renderiza a Tabela
        function renderTable(items, isPlaceholder) {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            
            if (items.length === 0 && !isPlaceholder) {
                document.getElementById('no-data-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-data-message').classList.add('hidden');

            items.forEach((item, index) => {
                
                // Insere o cabeçalho do bloco (divisor e títulos) a cada 3 itens
                if (index % 3 === 0) {
                    const groupRow = document.createElement('tr');
                    const blockName = getBlockName(index);
                    groupRow.innerHTML = `
                        <td colspan="7" class="week-divider px-4 py-2 border-t border-b border-indigo-200">
                            ${blockName}
                        </td>
                    `;
                    tbody.appendChild(groupRow);
                    tbody.appendChild(createHeaderRow()); // Cabeçalho repetido
                }

                const row = document.createElement('tr');
                const rowClass = getRowClass(item.culto, index);
                row.className = `${rowClass} hover:opacity-80 transition duration-150`;
                const textColorClass = 'text-gray-900';
                
                const currentDocId = item.id || 'null'; // Use 'null' string para placeholders

                // O botão de "Editar Data" e "Excluir" só aparece se o usuário for editor
                let actionButtons = '';
                if (isEditor) {
                    // Botão para editar Data/Dia/Culto (abre modal)
                    const editButtonAction = `openModal('${currentDocId}', '${item.date}', '${item.day}', '${item.culto}', '${item.portaria}', '${item.direcao}', '${item.preletor}')`;
                    
                    actionButtons += `<button onclick="${editButtonAction}"
                                class="font-semibold focus:outline-none text-indigo-600 hover:text-indigo-900"
                                title="Editar Data, Dia e Culto">
                            ${item.id ? 'Editar Data' : 'Preencher Data'}
                        </button>`;
                        
                    // Botão de Excluir (só para itens JÁ SALVOS)
                    if (item.id) {
                        actionButtons += `<button onclick="showConfirmModal('${item.id}')"
                                class="font-semibold focus:outline-none text-red-600 hover:text-red-900 ml-2"
                                title="Excluir item da escala">
                            Excluir
                        </button>`;
                    }
                } else {
                    actionButtons = `<span class="text-gray-400">Visualizar</span>`;
                }
                
                const cultoTextColorClass = 'text-indigo-700';
                
                const portariaSelect = createNameSelect(currentDocId, 'portaria', item.portaria);
                const direcaoSelect = createNameSelect(currentDocId, 'direcao', item.direcao);
                const preletorSelect = createNameSelect(currentDocId, 'preletor', item.preletor);

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${textColorClass}">${item.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${textColorClass}">${item.day}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm culto-cell font-bold ${cultoTextColorClass}">${item.culto}</td>
                    
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${portariaSelect}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${direcaoSelect}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${preletorSelect}</td>
                    
                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium space-x-2">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- Funções de Modal e CRUD ---
        window.openModal = function (docId = 'null', date = '', day = 'DOMINGO', culto = '', portaria = 'À DEFINIR', direcao = 'À DEFINIR', preletor = 'À DEFINIR') {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor.");
                return;
            }
            const modal = document.getElementById('entry-modal');
            const title = document.getElementById('modal-title');
            const saveButton = document.getElementById('save-button');
            
            document.getElementById('entry-id').value = docId === 'null' ? '' : docId; // Limpa se for placeholder
            document.getElementById('date-input').value = date;
            document.getElementById('day-input').value = day;
            document.getElementById('culto-input').value = culto;
            
            document.getElementById('portaria-input').value = portaria;
            document.getElementById('direcao-input').value = direcao;
            document.getElementById('preletor-input').value = preletor;

            if (docId !== 'null') {
                title.textContent = 'Editar Data/Culto (Nomes: Edição Direta)';
                saveButton.textContent = 'Atualizar Data/Culto';
            } else {
                title.textContent = 'Adicionar Novo Item na Escala';
                saveButton.textContent = 'Salvar Novo Item';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden'; 
        };

        window.closeModal = function () {
            const modal = document.getElementById('entry-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            document.getElementById('entry-form').reset();
        };

        document.getElementById('entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor para modificar.");
                return;
            }
            
            const docId = document.getElementById('entry-id').value;
            const date = document.getElementById('date-input').value.trim();
            const day = document.getElementById('day-input').value.trim();
            const culto = document.getElementById('culto-input').value.trim();
            
            // Pega os nomes da tabela (se estiver editando um item existente no modal, eles podem ter sido atualizados)
            const portaria = document.getElementById('portaria-input').value.trim();
            const direcao = document.getElementById('direcao-input').value.trim();
            const preletor = document.getElementById('preletor-input').value.trim();

            if (!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
                console.error("Erro de validação: Por favor, use o formato de data DD/MM/AAAA.");
                return;
            }

            const newEntry = {
                date: date,
                day: day,
                culto: culto,
                portaria: portaria, 
                direcao: direcao,
                preletor: preletor,
                timestamp: new Date().getTime(), 
                lastModifiedBy: auth.currentUser?.email || 'Editor (Email/Senha)',
            };
            
            closeModal(); 

            try {
                if (docId) {
                    const docRef = doc(db, getCollectionPath(), docId);
                    await setDoc(docRef, newEntry, { merge: true }); 
                    console.log("Documento atualizado com sucesso:", docId);
                } else {
                    await addDoc(collection(db, getCollectionPath()), newEntry);
                    console.log("Novo documento adicionado com sucesso.");
                }
            } catch (error) {
                console.error("Erro ao salvar o documento:", error);
            }
        });
        
        // Funções para o Modal de Confirmação (Exclusão)
        let docIdToDelete = null;

        window.showConfirmModal = function(id) {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor.");
                return;
            }
            docIdToDelete = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        };

        window.hideConfirmModal = function() {
            docIdToDelete = null;
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
            document.body.style.overflow = '';
        };

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor.");
                hideConfirmModal();
                return;
            }

            if (docIdToDelete && db) {
                try {
                    await deleteDoc(doc(db, getCollectionPath(), docIdToDelete));
                    console.log("Documento excluído com sucesso:", docIdToDelete);
                } catch (error) {
                    console.error("Erro ao excluir o documento:", error);
                }
            }
            hideConfirmModal();
        });


        // Inicia a aplicação no carregamento da janela
        window.onload = setupFirebase;
    </script>
</body>
</html>
