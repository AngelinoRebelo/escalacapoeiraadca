<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Portaria, Direção e Preletor</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilos personalizados para a tabela */
        /* COR NEUTRA: Tonalidade escura para o cabeçalho */
        .table-header {
            background-color: #374151; /* Dark Gray/Indigo */
            color: white;
            font-weight: 600;
        }
        /* COR NEUTRA: Cor de Fundo do Divisor de Semana */
        .week-divider {
            background-color: #F0F4FF; /* Very Light Blue/Indigo */
            font-weight: 700;
            color: #1E40AF; /* Dark Blue for contrast */
            text-align: center;
        }
        /* Estilo para a célula de culto (serviço) */
        .culto-cell {
            font-weight: 500;
            text-transform: uppercase;
        }
        
        /* CORES DE FUNDO ALTERNADAS E ESPECIAIS (NEUTRAS) */
        /* Linha com fundo branco/off-white */
        .culto-color-light-grey {
            background-color: #F9FAFB; 
        }
        /* Linha com fundo azul muito claro e neutro */
        .culto-color-light-blue {
            background-color: #F0F9FF;
        }
        /* Destaque para CULTO DE MISSÕES (Tonalidade de índigo suave) */
        .culto-missoes {
            background-color: #E0E7FF; /* Indigo-200 */
        }
        /* Destaque para SANTA CEIA (Cor escura neutra com texto branco) */
        .culto-santa-ceia {
            background-color: #374151; /* Dark Gray/Indigo */
            color: white;
        }
        /* Garante que o texto dentro da linha escura fique branco */
        .culto-santa-ceia td {
            color: white !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Título Principal -->
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Escala dos Cultos</h1>
            <p id="auth-status" class="text-sm text-gray-600">Carregando autenticação...</p>
        </header>

        <!-- Controles, Filtros e Botão de Adicionar -->
        <div class="flex justify-between items-center mb-6">
            <!-- Selectors de Filtro -->
            <div class="flex space-x-3">
                <!-- Seletor de Mês -->
                <select id="month-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                <!-- Seletor de Ano -->
                <select id="year-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
            </div>
            <!-- Botão de Adicionar -->
            <button id="add-entry-btn" onclick="openModal()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                + Adicionar Item na Escala
            </button>
        </div>

        <!-- Tabela de Escala (Responsiva) -->
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- Cabeçalho da Tabela -->
                    <thead class="table-header sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider rounded-tl-xl">Data</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Dia</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Culto</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Portaria</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Direção</th>
                            <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Preletor</th>
                            <th class="px-4 py-3 text-center text-xs uppercase tracking-wider rounded-tr-xl">Ações</th>
                        </tr>
                    </thead>
                    <!-- Corpo da Tabela (Preenchido via JavaScript) -->
                    <tbody id="schedule-body" class="bg-white divide-y divide-gray-100">
                        <!-- Linhas da escala serão injetadas aqui -->
                        <tr>
                            <td colspan="7" class="py-12 text-center text-gray-500">
                                <span class="animate-pulse">Carregando escala em tempo real...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="no-data-message" class="hidden p-6 text-center text-gray-500">
                Nenhum item na escala. Adicione o primeiro item acima!
            </div>
        </div>
        
        <!-- Informações do Usuário/App (Apenas para debug em desenvolvimento, mas necessário para Firestore) -->
        <footer class="mt-8 text-xs text-gray-500 p-4 bg-gray-100 rounded-lg">
            <p><strong>App ID:</strong> <span id="display-app-id"></span></p>
            <p><strong>User ID:</strong> <span id="display-user-id"></span></p>
            <p>Este app usa o Firestore para colaboração em tempo real.</p>
        </footer>
    </div>
    
    <!-- Modal (Formulário) -->
    <div id="entry-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <!-- Título do Modal -->
            <header class="bg-indigo-600 p-4 text-white">
                <h2 id="modal-title" class="text-2xl font-bold">Adicionar Novo Item</h2>
            </header>
            
            <!-- Formulário -->
            <form id="entry-form" class="p-6 space-y-4">
                <input type="hidden" id="entry-id">
                
                <!-- Data -->
                <div>
                    <label for="date-input" class="block text-sm font-medium text-gray-700">Data (DD/MM/AAAA)</label>
                    <input type="text" id="date-input" placeholder="Ex: 03/10/2025" required pattern="\d{2}/\d{2}/\d{4}"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Formato obrigatório: DD/MM/AAAA</p>
                </div>
                
                <!-- Dia da Semana -->
                <div>
                    <label for="day-input" class="block text-sm font-medium text-gray-700">Dia da Semana</label>
                    <select id="day-input" required
                            class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="DOMINGO">DOMINGO</option>
                        <option value="SEGUNDA-FEIRA">SEGUNDA-FEIRA</option>
                        <option value="TERÇA-FEIRA">TERÇA-FEIRA</option>
                        <option value="QUARTA-FEIRA">QUARTA-FEIRA</option>
                        <option value="QUINTA-FEIRA">QUINTA-FEIRA</option>
                        <option value="SEXTA-FEIRA">SEXTA-FEIRA</option>
                        <option value="SÁBADO">SÁBADO</option>
                    </select>
                </div>

                <!-- Culto -->
                <div>
                    <label for="culto-input" class="block text-sm font-medium text-gray-700">Culto (Serviço)</label>
                    <input type="text" id="culto-input" placeholder="Ex: DOUTRINA, LOUVOR E ADORAÇÃO" required
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- Portaria -->
                <div>
                    <label for="portaria-input" class="block text-sm font-medium text-gray-700">Portaria</label>
                    <input type="text" id="portaria-input" placeholder="Ex: Miss Vanessa/Obr Clemiton" required
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- Direção -->
                <div>
                    <label for="direcao-input" class="block text-sm font-medium text-gray-700">Direção</label>
                    <input type="text" id="direcao-input" placeholder="Ex: Diac Gladimir" required
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- Preletor -->
                <div>
                    <label for="preletor-input" class="block text-sm font-medium text-gray-700">Preletor</label>
                    <input type="text" id="preletor-input" placeholder="Ex: PR CARLOS" required
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- Botões de Ação -->
                <div class="flex justify-between pt-4">
                    <button type="button" onclick="closeModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" id="save-button"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Salvar Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação (Substitui alert/confirm) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <header class="bg-red-600 p-4 text-white">
                <h2 class="text-xl font-bold">Confirmação de Exclusão</h2>
            </header>
            <div class="p-6">
                <p id="confirm-message" class="text-gray-700 mb-6">Tem certeza de que deseja excluir este item da escala?</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideConfirmModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Não, Cancelar
                    </button>
                    <button type="button" id="confirm-delete-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Sim, Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Imports do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais (Obrigatório usar __app_id e __firebase_config)
        let app, db, auth;
        let userId = '';
        // Variáveis de filtro
        let currentMonth = new Date().getMonth() + 1; // 1-12
        let currentYear = new Date().getFullYear();
        
        // Define a configuração do Firebase
        const FIREBASE_CONFIG_OBJ = {
            apiKey: "AIzaSyAIVZC5Q8lfcMPCiv1oQzFm1oCajNB76c8",
            authDomain: "escala-adca-capoeira.firebaseapp.com",
            projectId: "escala-adca-capoeira",
            storageBucket: "escala-adca-capoeira.firebasestorage.app",
            messagingSenderId: "1015575781500",
            appId: "1:1015575781500:web:1c483c568b98dfd5cd29f9"
        };
        
        // Prioriza a variável de ambiente, mas usa a estática se não estiver presente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_OBJ;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-escala-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // URL da coleção pública (Obrigatório usar esta estrutura)
        const getCollectionPath = () => `/artifacts/${appId}/public/data/escala`;
        
        // Array de meses em português (1-indexado)
        const MONTH_NAMES = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        
        // Array de nomes dos dias da semana (0=Domingo)
        const DAY_NAMES = ["DOMINGO", "SEGUNDA-FEIRA", "TERÇA-FEIRA", "QUARTA-FEIRA", "QUINTA-FEIRA", "SEXTA-FEIRA", "SÁBADO"];


        // Função para converter data DD/MM/AAAA em objeto Date para comparação e ordenação
        const parseDate = (dateString) => {
            const parts = dateString.split('/');
            // A ordem é MM/DD/AAAA para o construtor do Date, mas a data na string é DD/MM/AAAA
            // Criamos a data como AAAA, MM-1, DD
            if (parts.length === 3) {
                const year = parseInt(parts[2], 10);
                const month = parseInt(parts[1], 10) - 1; // Mês é 0-indexado
                const day = parseInt(parts[0], 10);
                return new Date(year, month, day);
            }
            return new Date(0); // Data inválida
        };
        
        // Função para obter o nome da semana/bloco (usada para o divisor de grupo)
        const getBlockName = (index) => {
            const weekNumber = Math.floor(index / 3) + 1;
            const weekNames = ["PRIMEIRA", "SEGUNDA", "TERCEIRA", "QUARTA", "QUINTA", "SEXTA", "SÉTIMA", "OITAVA"];
            
            // Usa o mês filtrado atualmente para o título do bloco
            const monthName = MONTH_NAMES[currentMonth - 1].toUpperCase(); 
            
            if (weekNumber <= weekNames.length) {
                return `${weekNames[weekNumber - 1]} SEMANA DE ${monthName} DE ${currentYear}`;
            }
            return `BLOCO DE SERVIÇOS ${weekNumber}`;
        }
        
        // Atualiza os seletores de mês e ano e define os listeners
        function updateFiltersUI() {
            const monthSelect = document.getElementById('month-filter');
            const yearSelect = document.getElementById('year-filter');
            
            // Popula os meses
            monthSelect.innerHTML = MONTH_NAMES.map((name, index) => {
                const monthValue = index + 1;
                const isSelected = monthValue === currentMonth;
                return `<option value="${monthValue}" ${isSelected ? 'selected' : ''}>${name}</option>`;
            }).join('');
            
            // Popula os anos: de 1 ano antes até 2 anos depois
            const startYear = new Date().getFullYear() - 1; 
            const endYear = new Date().getFullYear() + 2;   
            
            yearSelect.innerHTML = '';
            for (let y = startYear; y <= endYear; y++) {
                const isSelected = y === currentYear;
                yearSelect.innerHTML += `<option value="${y}" ${isSelected ? 'selected' : ''}>${y}</option>`;
            }
            
            // Event Listeners
            monthSelect.onchange = (e) => {
                currentMonth = parseInt(e.target.value, 10);
                loadSchedule(); // Recarrega os dados com o novo filtro
            };

            yearSelect.onchange = (e) => {
                currentYear = parseInt(e.target.value, 10);
                loadSchedule(); // Recarrega os dados com o novo filtro
            };
        }


        /**
         * Gera entradas de placeholder para todas as semanas do mês selecionado.
         */
        const generatePlaceholderItems = (month, year) => {
            const targetMonth = month - 1; // 0-indexado
            const targetYear = year;
            
            // 1. Encontra o primeiro Domingo no mês/ano ou após o dia 1
            let currentDate = new Date(targetYear, targetMonth, 1); 
            currentDate.setDate(currentDate.getDate() + (0 - currentDate.getDay() + 7) % 7); 
            
            const daysInBlock = [0, 3, 5]; // Offsets: Domingo (0), Quarta (3), Sexta (5)
            const cultosInBlock = ["LOUVOR E ADORAÇÃO", "DOUTRINA", "LIBERTAÇÃO"];
            const placeholderItems = [];

            // 2. Itera semanalmente até que a data ultrapasse o mês alvo
            while (currentDate.getMonth() === targetMonth && currentDate.getFullYear() === targetYear) {
                
                // 3. Gera as 3 entradas do bloco semanal (Domingo, Quarta, Sexta)
                for (let i = 0; i < 3; i++) {
                    const blockDate = new Date(currentDate);
                    blockDate.setDate(currentDate.getDate() + daysInBlock[i]);
                    
                    // Verifica se a data gerada ainda está dentro do mês alvo (importante para o fim do mês)
                    if (blockDate.getMonth() !== targetMonth) {
                         continue; 
                    }
                    
                    const dayString = DAY_NAMES[blockDate.getDay()];
                    let cultoString = cultosInBlock[i];
                    
                    // Adiciona destaques especiais para o segundo e terceiro bloco (simulação)
                    const currentBlockIndex = Math.floor(placeholderItems.length / 3);
                    if (currentBlockIndex === 1 && i === 0) { // Segundo bloco, Domingo
                        cultoString = "SANTA CEIA";
                    } else if (currentBlockIndex === 2 && i === 1) { // Terceiro bloco, Quarta
                        cultoString = "CULTO DE MISSÕES";
                    }

                    placeholderItems.push({
                        id: null, 
                        date: `${String(blockDate.getDate()).padStart(2, '0')}/${String(blockDate.getMonth() + 1).padStart(2, '0')}/${blockDate.getFullYear()}`,
                        day: dayString,
                        culto: cultoString,
                        portaria: "À DEFINIR",
                        direcao: "À DEFINIR",
                        preletor: "À DEFINIR",
                        timestamp: blockDate.getTime()
                    });
                }
                
                // 4. Avança para o próximo Domingo (próximo bloco)
                currentDate.setDate(currentDate.getDate() + 7); 
            }
            return placeholderItems;
        };


        // Inicialização do Firebase e Autenticação
        async function setupFirebase() {
            // Verifica se a configuração existe.
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config não encontrado. A persistência não funcionará.");
                document.getElementById('auth-status').textContent = "ERRO: Configuração do Firebase ausente.";
                return;
            }
            try {
                // setLogLevel('debug'); // Descomente para ver logs do Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticação
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('auth-status').textContent = `Usuário autenticado: ${userId.substring(0, 8)}...`;
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Se não houver token, tenta anonimamente
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                            document.getElementById('auth-status').textContent = `Usuário anônimo: ${userId.substring(0, 8)}...`;
                        }
                        document.getElementById('display-app-id').textContent = appId;
                        document.getElementById('display-user-id').textContent = userId;
                        resolve();
                    });
                });

                // Inicia o listener de dados após a autenticação
                updateFiltersUI(); // Chama para popular os seletores antes de carregar
                loadSchedule();

            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                document.getElementById('auth-status').textContent = `ERRO: Falha na autenticação.`;
            }
        }

        // Carrega e escuta as mudanças na escala (Real-time)
        function loadSchedule() {
            if (!db) {
                console.error("Firestore não inicializado.");
                return;
            }

            const scaleRef = collection(db, getCollectionPath());
            
            const q = query(scaleRef); 

            onSnapshot(q, (snapshot) => {
                let schedule = [];
                snapshot.forEach(doc => {
                    schedule.push({ id: doc.id, ...doc.data() });
                });

                // 1. FILTRAGEM: Filtra a lista pelo mês e ano selecionados
                schedule = schedule.filter(item => {
                    // Espera formato DD/MM/AAAA
                    const parts = item.date.split('/');
                    if (parts.length === 3) {
                        const itemMonth = parseInt(parts[1], 10);
                        const itemYear = parseInt(parts[2], 10);
                        
                        return itemMonth === currentMonth && itemYear === currentYear;
                    }
                    return false; // Ignora datas mal formatadas
                });


                // 2. ORDENAÇÃO LOCAL
                schedule.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    // Compara primeiro por data e depois pelo timestamp para desempate
                    if (dateA - dateB !== 0) {
                        return dateA - dateB;
                    }
                    return a.timestamp - b.timestamp;
                });
                
                // 3. PLACEHOLDERS: Se a lista filtrada estiver vazia, gera placeholders para o mês/ano filtrado
                const finalSchedule = schedule.length === 0 ? generatePlaceholderItems(currentMonth, currentYear) : schedule;

                renderTable(finalSchedule, schedule.length === 0);
            }, (error) => {
                console.error("Erro ao receber dados da escala:", error);
                document.getElementById('schedule-body').innerHTML = `
                    <tr><td colspan="7" class="py-4 text-center text-red-500">
                        Erro ao carregar os dados: ${error.message}
                    </td></tr>`;
            });
        }

        /**
         * Retorna a classe CSS da linha com base no tipo de culto para replicar o visual.
         */
        function getRowClass(culto, index) {
            const upperCulto = culto.toUpperCase();
            
            // 1. Prioriza destaques específicos
            if (upperCulto.includes('SANTA CEIA')) {
                return 'culto-santa-ceia';
            }
            if (upperCulto.includes('CULTO DE MISSÕES')) {
                return 'culto-missoes';
            }
            
            // 2. Aplica cores neutras alternadas: (0=cinza claro, 1=azul claro, 2=cinza claro)
            const blockIndex = index % 3; 

            if (blockIndex === 0) {
                return 'culto-color-light-grey';
            } else if (blockIndex === 1) {
                return 'culto-color-light-blue';
            } else {
                 return 'culto-color-light-grey';
            }
        }


        // Renderiza a Tabela com agrupamento a cada 3 itens
        function renderTable(items, isPlaceholder) {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            
            if (items.length === 0 && !isPlaceholder) {
                document.getElementById('no-data-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-data-message').classList.add('hidden');

            // Itera sobre os itens para criar as linhas
            items.forEach((item, index) => {
                
                // Adiciona o divisor de grupo a cada 3 itens (item 0, 3, 6, etc.)
                if (index % 3 === 0) {
                    const groupRow = document.createElement('tr');
                    // Usa o mês/ano filtrado para nomear o bloco
                    const blockName = getBlockName(index);

                    groupRow.innerHTML = `
                        <td colspan="7" class="week-divider px-4 py-2 border-t border-b border-indigo-200">
                            ${blockName}
                        </td>
                    `;
                    tbody.appendChild(groupRow);
                }

                const row = document.createElement('tr');
                // Passa o índice do item para a função de classe para as cores alternadas no bloco
                const rowClass = getRowClass(item.culto, index);
                
                // Adiciona a classe de cor da linha e o hover
                row.className = `${rowClass} hover:opacity-80 transition duration-150`;
                
                // A cor do texto para células que estão em destaque (santa ceia) deve ser branca
                const textColorClass = rowClass.includes('culto-santa-ceia') ? 'text-white' : 'text-gray-900';
                
                // Se for placeholder, a ação de 'Editar' é na verdade 'Abrir modal para preencher'
                const editButtonAction = item.id 
                    ? `editEntry('${item.id}', '${item.date}', '${item.day}', '${item.culto}', '${item.portaria}', '${item.direcao}', '${item.preletor}')`
                    // Para placeholder, passamos todos os dados, mas o id é null, forçando a criação (addDoc)
                    : `openModal(null, '${item.date}', '${item.day}', '${item.culto}', '${item.portaria}', '${item.direcao}', '${item.preletor}')`;
                
                // O botão de Excluir só aparece se for um item salvo (com ID)
                const deleteButton = item.id 
                    ? `<button onclick="showConfirmModal('${item.id}')"
                                class="font-semibold focus:outline-none ${rowClass.includes('culto-santa-ceia') ? 'text-white hover:text-red-300' : 'text-red-600 hover:text-red-900'}">
                            Excluir
                        </button>`
                    : '';
                    
                // Ajusta a cor do texto do culto para ficar visível (mesmo com cores neutras, usa um tom de azul para destaque)
                const cultoTextColorClass = rowClass.includes('culto-santa-ceia') ? 'text-white' : 'text-indigo-700';


                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${textColorClass}">${item.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${textColorClass}">${item.day}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm culto-cell font-bold ${cultoTextColorClass}">${item.culto}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${textColorClass}">${item.portaria}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${textColorClass}">${item.direcao}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${textColorClass}">${item.preletor}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="${editButtonAction}"
                                class="font-semibold focus:outline-none ${rowClass.includes('culto-santa-ceia') ? 'text-white hover:text-indigo-300' : 'text-indigo-600 hover:text-indigo-900'}">
                            ${item.id ? 'Editar' : 'Preencher'}
                        </button>
                        ${deleteButton}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- Funções de Modal e CRUD (Expostas no escopo global para o HTML) ---
        window.openModal = function (docId = null, date = '', day = 'DOMINGO', culto = '', portaria = '', direcao = '', preletor = '') {
            const modal = document.getElementById('entry-modal');
            const title = document.getElementById('modal-title');
            const saveButton = document.getElementById('save-button');
            const form = document.getElementById('entry-form');

            // Preenche o formulário
            document.getElementById('entry-id').value = docId || '';
            document.getElementById('date-input').value = date;
            document.getElementById('day-input').value = day;
            document.getElementById('culto-input').value = culto;
            document.getElementById('portaria-input').value = portaria === "À DEFINIR" ? '' : portaria;
            document.getElementById('direcao-input').value = direcao === "À DEFINIR" ? '' : direcao;
            document.getElementById('preletor-input').value = preletor === "À DEFINIR" ? '' : preletor;

            // Configura o título e o botão
            if (docId) {
                title.textContent = 'Editar Item da Escala';
                saveButton.textContent = 'Atualizar Item';
            } else {
                title.textContent = 'Preencher Novo Item';
                saveButton.textContent = 'Salvar Novo Item';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden'; // Bloqueia o scroll de fundo
        };

        window.closeModal = function () {
            const modal = document.getElementById('entry-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            document.getElementById('entry-form').reset();
        };
        
        // Wrapper para editar (apenas para não poluir a função editEntry com argumentos desnecessários)
        window.editEntry = function(id, date, day, culto, portaria, direcao, preletor) {
            openModal(id, date, day, culto, portaria, direcao, preletor);
        }

        // Lidar com o envio do formulário (Salvar/Atualizar)
        document.getElementById('entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('entry-id').value;
            const date = document.getElementById('date-input').value.trim();
            const day = document.getElementById('day-input').value.trim();
            const culto = document.getElementById('culto-input').value.trim();
            // Se os campos de nome estiverem vazios, define como "À DEFINIR"
            const portaria = document.getElementById('portaria-input').value.trim() || 'À DEFINIR';
            const direcao = document.getElementById('direcao-input').value.trim() || 'À DEFINIR';
            const preletor = document.getElementById('preletor-input').value.trim() || 'À DEFINIR';

            // Validação de Data (apenas para garantir o formato)
            if (!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
                console.error("Erro de validação: Por favor, use o formato de data DD/MM/AAAA.");
                return;
            }

            const newEntry = {
                date: date,
                day: day,
                culto: culto,
                portaria: portaria,
                direcao: direcao,
                preletor: preletor,
                timestamp: new Date().getTime(), // Para ordenação
                lastModifiedBy: userId 
            };
            
            closeModal(); // Fecha imediatamente para dar feedback de progresso

            try {
                if (docId) {
                    // Atualizar item existente
                    const docRef = doc(db, getCollectionPath(), docId);
                    await setDoc(docRef, newEntry, { merge: true });
                    console.log("Documento atualizado com sucesso:", docId);
                } else {
                    // Adicionar novo item (usado para salvar o placeholder preenchido)
                    await addDoc(collection(db, getCollectionPath()), newEntry);
                    console.log("Novo documento adicionado com sucesso.");
                }
            } catch (error) {
                console.error("Erro ao salvar o documento:", error);
                // Em um app real, você mostraria uma notificação de erro aqui
            }
        });
        
        // Funções para o Modal de Confirmação (Exclusão)
        let docIdToDelete = null;

        window.showConfirmModal = function(id) {
            docIdToDelete = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        };

        window.hideConfirmModal = function() {
            docIdToDelete = null;
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
            document.body.style.overflow = '';
        };

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (docIdToDelete && db) {
                try {
                    await deleteDoc(doc(db, getCollectionPath(), docIdToDelete));
                    console.log("Documento excluído com sucesso:", docIdToDelete);
                } catch (error) {
                    console.error("Erro ao excluir o documento:", error);
                }
            }
            hideConfirmModal();
        });


        // Inicia a aplicação no carregamento da janela
        window.onload = setupFirebase;
    </script>
</body>
</html>
