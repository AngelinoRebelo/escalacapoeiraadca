<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Portaria, Direção e Preletor</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilos personalizados para a tabela */
        .table-header {
            background-color: #374151; /* Dark Gray/Indigo */
            color: white;
            font-weight: 600;
        }
        .week-divider {
            background-color: #F0F4FF; /* Very Light Blue/Indigo */
            font-weight: 700;
            color: #1E40AF; /* Dark Blue for contrast */
            text-align: center;
        }
        .culto-cell {
            font-weight: 500;
            text-transform: uppercase;
        }
        
        /* CORES DE FUNDO ALTERNADAS E ESPECIAIS (NEUTRAS) */
        .culto-color-light-grey {
            background-color: #F9FAFB; 
        }
        .culto-color-light-blue {
            background-color: #F0F9FF;
        }
        .culto-missoes {
            background-color: #E0E7FF; /* Indigo-200 */
        }
        .culto-missoes td {
            color: #1F2937 !important; 
        }
        
        #main-table-header {
            display: none;
        }

        /* Estilo para os SELECTs inline */
        .inline-select {
            appearance: none; /* Remove seta padrão */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%236b7280%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 0.8rem;
            padding-right: 1.5rem; /* Espaço para a seta */
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            height: 1.75rem; /* Altura padrão */
            width: 100%;
            min-width: 120px;
            max-width: 200px;
            cursor: pointer;
        }
        
        /* Estilo para o botão Salvar Escala (Novo) */
        #save-button {
            background-color: #10B981; /* Green-500 */
            color: white;
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s, transform 0.1s;
        }
        #save-button:hover {
            background-color: #059669; /* Green-600 */
            transform: scale(1.02);
        }

        /* Estilo para o botão/ícone sutil de adição */
        #subtle-add-btn {
            background-color: #6366F1; /* Indigo-500 */
            color: white;
            padding: 8px 12px;
            border-radius: 9999px; /* Full rounded */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, transform 0.1s;
        }
        #subtle-add-btn:hover {
            background-color: #4F46E5; /* Indigo-600 */
            transform: scale(1.05);
        }
        /* Estilo para o botão de Logar/Sair */
        #auth-button {
            padding: 8px 16px;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #auth-button.logged-out {
            background-color: #10B981; /* Green-500 */
            color: white;
        }
        #auth-button.logged-out:hover {
            background-color: #059669; /* Green-600 */
        }
        #auth-button.logged-in {
            background-color: #EF4444; /* Red-500 */
            color: white;
        }
        #auth-button.logged-in:hover {
            background-color: #DC2626; /* Red-600 */
        }
        
        /* Estilo das abas */
        .tab-button {
            padding: 8px 16px;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
        }
        .tab-button.active {
            border-bottom-color: #6366F1; /* Indigo-500 */
            color: #111827; /* Gray-900 */
        }
        .tab-button:not(.active):hover {
            border-bottom-color: #D1D5DB;
        }
        
        /* Estilo para a célula de erro/tooltip de não logado */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            width: 150px;
            background-color: #374151;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 10;
            bottom: 125%; 
            left: 50%;
            margin-left: -75px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }

        /* Estilo para os ícones de ação no divisor de semana */
        .block-action-icon {
            cursor: pointer;
            color: #1E40AF;
            transition: color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        .block-action-icon:hover {
            transform: scale(1.1);
        }
        .block-action-icon.add:hover {
            color: #10B981; /* Green-500 */
            background-color: #D1FAE5;
        }
        .block-action-icon.remove:hover {
            color: #EF4444; /* Red-500 */
            background-color: #FEE2E2;
        }
        
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Título Principal e Botão de Login/Logout -->
        <header class="mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Escala dos Cultos</h1>
                <p id="auth-status" class="text-sm text-gray-600">Carregando autenticação...</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Status de Salvamento (Novo) -->
                <span id="save-status" class="text-sm font-semibold text-green-600 hidden">Salvo!</span>

                <!-- Botão de Salvar Escala (Novo) -->
                <button id="save-button" onclick="archiveScale()" class="hidden">
                    Salvar Escala
                </button>
                
                <!-- Ícone sutil para Adicionar Item (Apenas visível se logado) -->
                <button id="subtle-add-btn" onclick="openModal()" title="Adicionar Novo Item na Escala (Data, Dia, Culto)" class="hidden">
                    <!-- Ícone Plus (Lucide-react SVG inline) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M5 12h14"/>
                        <path d="M12 5v14"/>
                    </svg>
                </button>

                <!-- Botão de Logar/Sair -->
                <button id="auth-button" class="logged-out" onclick="handleAuthClick()">
                    Logar para Editar
                </button>
            </div>
        </header>

        <!-- Navegação por Abas -->
        <div class="flex border-b border-gray-300 mb-6">
            <button id="current-tab" class="tab-button active" onclick="switchView('current')">
                Escala Atual
            </button>
            <button id="saved-tab" class="tab-button" onclick="switchView('saved')">
                Escalas Salvas
            </button>
        </div>

        <!-- Conteúdo da Aba: ESCALA ATUAL (Edição) -->
        <div id="current-view">
            <!-- Controles, Filtros -->
            <div class="flex justify-start items-center mb-6 space-x-3">
                <!-- Seletor de Mês -->
                <select id="month-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                <!-- Seletor de Ano -->
                <select id="year-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
            </div>

            <!-- Tabela de Escala (Responsiva) -->
            <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="main-table-header">
                            <!-- Cabeçalho Vazio (Mantido para a estrutura da tabela, mas invisível) -->
                        </thead>
                        <!-- Corpo da Tabela (Preenchido via JavaScript) -->
                        <tbody id="schedule-body" class="bg-white divide-y divide-gray-100">
                            <tr>
                                <td colspan="7" class="py-12 text-center text-gray-500">
                                    <span class="animate-pulse">Carregando escala em tempo real...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="no-data-message" class="hidden p-6 text-center text-gray-500">
                    Nenhum item na escala para o mês selecionado. Logue como Editor para gerar ou adicionar novas datas.
                </div>
            </div>
        </div>
        
        <!-- Conteúdo da Aba: ESCALAS SALVAS (Visualização) -->
        <div id="saved-view" class="hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Versões Arquivadas</h2>
                <div id="archive-list" class="space-y-3">
                    <p class="text-gray-500">Carregando lista de escalas salvas...</p>
                </div>

                <!-- Área de Visualização da Escala Salva -->
                <div id="archived-scale-display" class="mt-8 hidden">
                    <h3 id="archived-scale-title" class="text-xl font-bold mb-4 border-b pb-2 text-indigo-700"></h3>
                    <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-gray-200">
                            <tbody id="archived-schedule-body" class="bg-white divide-y divide-gray-100">
                                <!-- Conteúdo da escala salva será injetado aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informações do Usuário/App -->
        <footer class="mt-8 text-xs text-gray-500 p-4 bg-gray-100 rounded-lg">
            <p><strong>App ID:</strong> <span id="display-app-id"></span></p>
            <p><strong>User ID:</strong> <span id="display-user-id"></span></p>
            <p>Este app usa o Firestore para colaboração em tempo real.</p>
        </footer>
    </div>
    
    <!-- Modal de Login -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <header class="bg-indigo-600 p-4 text-white">
                <h2 class="text-2xl font-bold">Acesso de Editor</h2>
            </header>
            
            <form id="login-form" class="p-6 space-y-4">
                <p id="login-error" class="text-sm text-red-600 hidden">Credenciais inválidas. Tente novamente.</p>
                <div class="text-sm text-gray-600 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                    <p>Use o email e senha **cadastrados no seu Firebase**.</p>
                    <p class="mt-1">A autenticação por Email/Senha deve estar ativa no seu projeto.</p>
                </div>

                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" required placeholder="Seu Email"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" required placeholder="Sua Senha"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="flex justify-between pt-4">
                    <button type="button" onclick="closeLoginModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Logar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal (Formulário) - Usado APENAS para Data, Dia e Culto -->
    <div id="entry-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <!-- Título do Modal -->
            <header class="bg-indigo-600 p-4 text-white">
                <h2 id="modal-title" class="text-2xl font-bold">Adicionar Novo Item</h2>
            </header>
            
            <!-- Formulário -->
            <form id="entry-form" class="p-6 space-y-4">
                <input type="hidden" id="entry-id">
                
                <!-- Data -->
                <div>
                    <label for="date-input" class="block text-sm font-medium text-gray-700">Data (DD/MM/AAAA)</label>
                    <input type="text" id="date-input" placeholder="Ex: 03/10/2025" required pattern="\d{2}/\d{2}/\d{4}"
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Formato obrigatório: DD/MM/AAAA</p>
                </div>
                
                <!-- Dia da Semana -->
                <div>
                    <label for="day-input" class="block text-sm font-medium text-gray-700">Dia da Semana</label>
                    <select id="day-input" required
                            class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="DOMINGO">DOMINGO</option>
                        <option value="SEGUNDA-FEIRA">SEGUNDA-FEIRA</option>
                        <option value="TERÇA-FEIRA">TERÇA-FEIRA</option>
                        <option value="QUARTA-FEIRA">QUARTA-FEIRA</option>
                        <option value="QUINTA-FEIRA">QUINTA-FEIRA</option>
                        <option value="SEXTA-FEIRA">SEXTA-FEIRA</option>
                        <option value="SÁBADO">SÁBADO</option>
                    </select>
                </div>

                <!-- Culto -->
                <div>
                    <label for="culto-input" class="block text-sm font-medium text-gray-700">Culto (Serviço)</label>
                    <input type="text" id="culto-input" placeholder="Ex: DOUTRINA, LOUVOR E ADORAÇÃO" required
                           class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- Campos de Nomes (Escondidos, pois a edição é inline na tabela) -->
                <input type="hidden" id="portaria-input" value="À DEFINIR">
                <input type="hidden" id="direcao-input" value="À DEFINIR">
                <input type="hidden" id="preletor-input" value="À DEFINIR">

                <!-- Botões de Ação -->
                <div class="flex justify-between pt-4">
                    <button type="button" onclick="closeModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" id="save-item-button"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Salvar Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação (Substitui alert/confirm) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <header class="bg-red-600 p-4 text-white">
                <h2 class="text-xl font-bold">Confirmação de Exclusão</h2>
            </header>
            <div class="p-6">
                <p id="confirm-message" class="text-gray-700 mb-6">Tem certeza de que deseja excluir este item da escala?</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideConfirmModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Não, Cancelar
                    </button>
                    <button type="button" id="confirm-delete-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Sim, Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão de Bloco -->
    <div id="confirm-block-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-3xl w-full max-w-sm overflow-hidden transform transition-all duration-300">
            <header class="bg-red-600 p-4 text-white">
                <h2 class="text-xl font-bold">Excluir Bloco de Cultos</h2>
            </header>
            <div class="p-6">
                <p id="confirm-block-message" class="text-gray-700 mb-6">
                    Tem certeza de que deseja excluir o bloco completo de cultos? Esta ação removerá 3 itens do banco de dados.
                </p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideConfirmBlockModal()"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                        Não, Cancelar
                    </button>
                    <button type="button" id="confirm-block-delete-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Sim, Excluir Bloco
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Imports do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, addDoc, deleteDoc, getDocs, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais 
        let app, db, auth;
        let userId = '';
        let isEditor = false; // Controla a permissão de edição
        let currentView = 'current'; // 'current' ou 'saved'
        let currentMonth = new Date().getMonth() + 1; // 1-12
        let currentYear = new Date().getFullYear();
        let allCurrentScheduleItems = []; // Armazena todos os itens da escala atual para arquivamento
        
        // --- LISTA DE NOMES PREDEFINIDOS ---
        const PREDEFINED_NAMES = [
            "PR. GABRIEL", "PRB. LEANDRO", "MISS. KELLY", "MISS.ANA", 
            "MISS.LORRANE", "MISS.ESTER", "DCa.SIMONE", "DCa. RAQUEL", 
            "DCa. ROSA", "OB. CLEMILTON", "OB. MARCOS", "OB. JANETE", 
            "OB. ANA ROCHA", "IR. GABRIEL", "IR. VITÓRIA", "DCa. CRISTIANE"
        ].sort(); 
        
        // Define a configuração do Firebase
        const FIREBASE_CONFIG_OBJ = {
            apiKey: "AIzaSyAIVZC5Q8lfcMPCiv1oQzFm1oCajNB76c8",
            authDomain: "escala-adca-capoeira.firebaseapp.com",
            projectId: "escala-adca-capoeira",
            storageBucket: "escala-adca-capoeira.firebasestorage.app",
            messagingSenderId: "1015575781500",
            appId: "1:1015575781500:web:1c483c568b98dfd5cd29f9"
        };
        
        // Prioriza a variável de ambiente, mas usa a estática se não estiver presente.
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_OBJ;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-escala-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // URL das coleções
        const getCurrentCollectionPath = () => `/artifacts/${appId}/public/data/escala`;
        const getArchiveCollectionPath = () => `/artifacts/${appId}/public/data/escalas_salvas`;
        
        // Array de meses em português (1-indexado)
        const MONTH_NAMES = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        
        // Array de nomes dos dias da semana (0=Domingo)
        const DAY_NAMES = ["DOMINGO", "SEGUNDA-FEIRA", "TERÇA-FEIRA", "QUARTA-FEIRA", "QUINTA-FEIRA", "SEXTA-FEIRA", "SÁBADO"];


        // Função para converter data DD/MM/AAAA em objeto Date para comparação e ordenação
        const parseDate = (dateString) => {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const year = parseInt(parts[2], 10);
                const month = parseInt(parts[1], 10) - 1; 
                const day = parseInt(parts[0], 10);
                return new Date(year, month, day);
            }
            return new Date(0); 
        };
        
        // Função para obter o nome da semana/bloco (usada para o divisor de grupo)
        const getBlockName = (index) => {
            const weekNumber = Math.floor(index / 3) + 1;
            const weekNames = ["PRIMEIRA", "SEGUNDA", "TERCEIRA", "QUARTA", "QUINTA", "SEXTA", "SÉTIMA", "OITAVA"];
            
            const monthName = MONTH_NAMES[currentMonth - 1].toUpperCase(); 
            
            if (weekNumber <= weekNames.length) {
                return `${weekNames[weekNumber - 1]} SEMANA DE ${monthName} DE ${currentYear}`;
            }
            return `BLOCO DE SERVIÇOS ${weekNumber}`;
        }
        
        // Atualiza os seletores de mês e ano e define os listeners
        function updateFiltersUI() {
            const monthSelect = document.getElementById('month-filter');
            const yearSelect = document.getElementById('year-filter');
            
            // Popula os meses
            monthSelect.innerHTML = MONTH_NAMES.map((name, index) => {
                const monthValue = index + 1;
                const isSelected = monthValue === currentMonth;
                return `<option value="${monthValue}" ${isSelected ? 'selected' : ''}>${name}</option>`;
            }).join('');
            
            // Popula os anos: de 1 ano antes até 2 anos depois
            const startYear = new Date().getFullYear() - 1; 
            const endYear = new Date().getFullYear() + 2;   
            
            yearSelect.innerHTML = '';
            for (let y = startYear; y <= endYear; y++) {
                const isSelected = y === currentYear;
                yearSelect.innerHTML += `<option value="${y}" ${isSelected ? 'selected' : ''}>${y}</option>`;
            }
            
            // Event Listeners
            monthSelect.onchange = (e) => {
                currentMonth = parseInt(e.target.value, 10);
                // Reseta a visualização para a escala atual ao mudar o filtro
                switchView('current'); 
                loadSchedule(); 
            };

            yearSelect.onchange = (e) => {
                currentYear = parseInt(e.target.value, 10);
                // Reseta a visualização para a escala atual ao mudar o filtro
                switchView('current'); 
                loadSchedule(); 
            };
        }


        /**
         * Gera entradas de placeholder para todas as semanas do mês seleccionado.
         */
        const generatePlaceholderItems = (month, year) => {
            const targetMonth = month - 1; // 0-indexado
            const targetYear = year;
            
            // Avança para o primeiro Domingo do mês (ou antes, se o mês começar no meio da semana)
            let firstDayOfMonth = new Date(targetYear, targetMonth, 1);
            let dayOffset = (0 - firstDayOfMonth.getDay() + 7) % 7; 
            let firstSunday = new Date(targetYear, targetMonth, 1 + dayOffset);

            let currentDate = firstSunday; // Começa a iteração no primeiro Domingo relevante

            const daysInBlock = [0, 3, 5]; // Domingo, Quarta, Sexta
            const cultosInBlock = ["LOUVOR E ADORAÇÃO", "DOUTRINA", "LIBERTAÇÃO"];
            const placeholderItems = [];

            // Itera pelas semanas
            let maxIterations = 6; 
            for(let week = 0; week < maxIterations; week++) {
                let blockItems = [];
                let blockStartDate = new Date(currentDate);

                // Itera pelos 3 cultos na semana (D, Q, S)
                for (let i = 0; i < 3; i++) {
                    const blockDate = new Date(blockStartDate);
                    blockDate.setDate(blockStartDate.getDate() + daysInBlock[i]);
                    
                    // Verifica se a data pertence ao mês selecionado.
                    // Adiciona se a data for no mês atual, ou se for no mês anterior mas o primeiro bloco
                    if (blockDate.getMonth() !== targetMonth && week > 0) {
                        continue;
                    }
                    
                    const dayString = DAY_NAMES[blockDate.getDay()];
                    let cultoString = cultosInBlock[i];
                    
                    blockItems.push({
                        id: 'null', // Use string 'null' para placeholders
                        date: `${String(blockDate.getDate()).padStart(2, '0')}/${String(blockDate.getMonth() + 1).padStart(2, '0')}/${blockDate.getFullYear()}`,
                        day: dayString,
                        culto: cultoString,
                        portaria: "À DEFINIR",
                        direcao: "À DEFINIR",
                        preletor: "À DEFINIR",
                        timestamp: blockDate.getTime()
                    });
                }
                
                // Adiciona o bloco se houver itens válidos
                if (blockItems.length > 0) {
                    placeholderItems.push(...blockItems);
                }

                // Avança para o próximo domingo
                currentDate.setDate(currentDate.getDate() + 7); 
                
                // Se o próximo domingo já estiver fora do mês E passou do primeiro bloco, para a iteração
                if (currentDate.getMonth() !== targetMonth && week > 0) {
                    break;
                }
            }

            return placeholderItems;
        };
        
        // --- FUNÇÕES DE AUTENTICAÇÃO E UI DE EDITOR ---

        function updateAuthUI() {
            const authButton = document.getElementById('auth-button');
            const subtleAddBtn = document.getElementById('subtle-add-btn');
            const saveButton = document.getElementById('save-button');
            
            if (isEditor) {
                // Usuário logado como editor
                authButton.textContent = 'Sair';
                authButton.classList.remove('logged-out');
                authButton.classList.add('logged-in');
                subtleAddBtn.classList.remove('hidden'); // Mostra o botão de adicionar
                saveButton.classList.remove('hidden'); // Mostra o botão de salvar
                document.getElementById('auth-status').textContent = `Editor logado: ${auth.currentUser.email}`;
            } else {
                // Usuário não logado como editor
                authButton.textContent = 'Logar para Editar';
                authButton.classList.remove('logged-in');
                authButton.classList.add('logged-out');
                subtleAddBtn.classList.add('hidden'); // Esconde o botão de adicionar
                saveButton.classList.add('hidden'); // Esconde o botão de salvar
                document.getElementById('auth-status').textContent = `Modo visualização. Faça login para editar.`;
            }
            // Chama renderTable para re-habilitar/desabilitar os SELECTs e botões de acordo com o novo estado de login
            if (currentView === 'current') {
                loadSchedule();
            }
        }
        
        window.openLoginModal = function() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
            document.getElementById('login-error').classList.add('hidden');
        }

        window.closeLoginModal = function() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('flex');
            document.body.style.overflow = '';
            document.getElementById('login-form').reset();
        }

        window.handleAuthClick = async function() {
            if (isEditor) {
                // Se estiver logado, faz logout e reinicia o estado
                try {
                    await signOut(auth);
                    // O onAuthStateChanged tratará do resto
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                }
            } else {
                // Se não estiver logado, abre o modal de login
                openLoginModal();
            }
        }
        
        // FUNÇÃO DE LOGIN PARA USAR AUTENTICAÇÃO REAL DO FIREBASE
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDisplay = document.getElementById('login-error');
            
            errorDisplay.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                
                // Se bem-sucedido, o onAuthStateChanged irá definir isEditor = true
                closeLoginModal();
                
            } catch (error) {
                console.error("Erro de login:", error);
                let errorMessage = "Erro ao tentar logar. Verifique o email e senha.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                     errorMessage = "Email ou senha incorretos.";
                } else if (error.code === 'auth/invalid-email') {
                     errorMessage = "Formato de email inválido.";
                } else if (error.code === 'auth/operation-not-allowed') {
                     errorMessage = "A autenticação por Email/Senha não está ativada no seu projeto Firebase.";
                }
                errorDisplay.textContent = errorMessage;
                errorDisplay.classList.remove('hidden');
            }
        });
        
        // --- FUNÇÕES DE GERENCIAMENTO DE BLOCO (Adicionar/Remover Cultos) ---
        
        // Adiciona um novo culto ao final do bloco (usando o modal)
        window.addNewCultoToBlock = function(blockIndex) {
            if (!isEditor) return;
            openModal('null', '', 'DOMINGO', 'LOUVOR E ADORAÇÃO', 'À DEFINIR', 'À DEFINIR', 'À DEFINIR');
        }
        
        let itemsInBlockToRemove = [];
        window.showConfirmBlockModal = function(blockItems) {
            if (!isEditor) return;
            
            itemsInBlockToRemove = blockItems.filter(item => item.id !== 'null');
            
            if (itemsInBlockToRemove.length === 0) {
                 // Se não há itens salvos, remove os placeholders forçando o recarregamento
                 alert("Este bloco não possui itens salvos no banco de dados.");
                 return;
            }
            
            document.getElementById('confirm-block-message').innerHTML = `
                Tem certeza de que deseja excluir o bloco completo de ${itemsInBlockToRemove.length} cultos? 
                Esta ação removerá todos os itens salvos deste bloco do banco de dados.
            `;
            document.getElementById('confirm-block-modal').classList.remove('hidden');
            document.getElementById('confirm-block-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        window.hideConfirmBlockModal = function() {
            itemsInBlockToRemove = [];
            document.getElementById('confirm-block-modal').classList.add('hidden');
            document.getElementById('confirm-block-modal').classList.remove('flex');
            document.body.style.overflow = '';
        }
        
        document.getElementById('confirm-block-delete-btn').addEventListener('click', async () => {
            if (!isEditor || itemsInBlockToRemove.length === 0) {
                hideConfirmBlockModal();
                return;
            }

            try {
                // Executa a exclusão de todos os documentos do bloco em uma transação
                await runTransaction(db, async (transaction) => {
                    for (const item of itemsInBlockToRemove) {
                        const docRef = doc(db, getCurrentCollectionPath(), item.id);
                        transaction.delete(docRef);
                    }
                });
                console.log(`Bloco de ${itemsInBlockToRemove.length} itens excluído com sucesso.`);
            } catch (error) {
                console.error("Erro ao excluir o bloco de cultos:", error);
            }
            hideConfirmBlockModal();
        });


        // --- FUNÇÃO DO NOVO BOTÃO SALVAR ESCALA (ARQUIVAMENTO/SOBRESCREVER) ---
        window.archiveScale = async function() {
            if (!isEditor || allCurrentScheduleItems.length === 0) {
                console.warn("Nenhum item na escala para arquivar ou sem permissão.");
                return;
            }
            
            const archiveId = `${String(currentMonth).padStart(2, '0')}-${currentYear}`;
            const monthName = MONTH_NAMES[currentMonth - 1];
            const saveButton = document.getElementById('save-button');
            const saveStatus = document.getElementById('save-status');

            saveButton.textContent = 'Arquivando...';
            saveButton.disabled = true;
            saveStatus.classList.add('hidden');

            try {
                // 1. Prepara os dados para arquivamento
                const archiveData = {
                    month: currentMonth,
                    year: currentYear,
                    title: `Escala de ${monthName} de ${currentYear}`,
                    archivedAt: new Date().toISOString(),
                    archivedBy: auth.currentUser?.email || 'Editor (Email/Senha)',
                    // Salva a lista de itens do mês/ano filtrado
                    schedule: allCurrentScheduleItems.map(({ id, ...rest }) => rest)
                };

                // 2. Salva como um único documento na coleção de Arquivos, usando setDoc para SOBRESCREVER
                const docRef = doc(db, getArchiveCollectionPath(), archiveId);
                await setDoc(docRef, archiveData); // setDoc sobrepõe automaticamente se o ID existir
                
                // 3. Feedback visual
                saveButton.textContent = 'Escala Arquivada!';
                saveStatus.textContent = `Escala de ${monthName} Salva!`;
                saveStatus.classList.remove('hidden');

                setTimeout(() => {
                    saveButton.textContent = 'Salvar Escala';
                    saveButton.disabled = false;
                    saveStatus.classList.add('hidden');
                }, 3000); 
                
                console.log(`Escala de ${monthName}/${currentYear} arquivada com sucesso (Sobrescreveu se existente).`);
            } catch (error) {
                console.error("Erro ao arquivar a escala:", error);
                saveButton.textContent = 'Erro ao Salvar!';
                saveButton.disabled = false;
                alert(`Erro ao salvar a escala: ${error.message}`);
            }
        }


        // --- INICIALIZAÇÃO E OBSERVAÇÃO ---
        async function setupFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config não encontrado. A persistência não funcionará.");
                document.getElementById('auth-status').textContent = "ERRO: Configuração do Firebase ausente.";
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listener de estado de autenticação
                onAuthStateChanged(auth, async (user) => {
                    isEditor = false;
                    
                    if (!user) {
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                user = auth.currentUser;
                            } catch (error) {
                                await signInAnonymously(auth);
                                user = auth.currentUser;
                            }
                        } else {
                            await signInAnonymously(auth);
                            user = auth.currentUser;
                        }
                    }
                    
                    // Verifica se o usuário logou com Email/Senha (o editor)
                    if (user && user.providerData.some(p => p.providerId === 'password')) {
                         isEditor = true; 
                    }
                    
                    userId = user?.uid || crypto.randomUUID();
                    document.getElementById('display-app-id').textContent = appId;
                    document.getElementById('display-user-id').textContent = userId;
                    
                    updateAuthUI();
                    
                    if (!document.getElementById('month-filter').options.length) {
                        updateFiltersUI();
                    }
                    // Garante que a visualização correta seja carregada após a autenticação
                    if (currentView === 'current') {
                        loadSchedule();
                    } else {
                        loadArchiveList();
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                document.getElementById('auth-status').textContent = `ERRO: Falha na autenticação.`;
            }
        }

        function loadSchedule() {
            if (!db || currentView !== 'current') return;
            const scaleRef = collection(db, getCurrentCollectionPath());
            const q = query(scaleRef); 
            
            // O onSnapshotListener é persistente, mas a função de renderização filtra a cada chamada
            onSnapshot(q, (snapshot) => {
                let schedule = [];
                snapshot.forEach(doc => {
                    schedule.push({ id: doc.id, ...doc.data() });
                });

                // 1. FILTRAGEM
                schedule = schedule.filter(item => {
                    const parts = item.date.split('/');
                    if (parts.length === 3) {
                        const itemMonth = parseInt(parts[1], 10);
                        const itemYear = parseInt(parts[2], 10);
                        return itemMonth === currentMonth && itemYear === currentYear;
                    }
                    return false; 
                });

                // 2. ORDENAÇÃO LOCAL
                schedule.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    if (dateA - dateB !== 0) {
                        return dateA - dateB;
                    }
                    return a.timestamp - b.timestamp;
                });
                
                // Salva a lista filtrada no escopo global para o arquivamento
                allCurrentScheduleItems = schedule;

                // 3. PLACEHOLDERS: Se a lista filtrada estiver vazia, gera placeholders
                const finalSchedule = schedule.length === 0 ? generatePlaceholderItems(currentMonth, currentYear) : schedule;

                renderTable(finalSchedule, schedule.length === 0, 'schedule-body');
            }, (error) => {
                console.error("Erro ao receber dados da escala:", error);
                document.getElementById('schedule-body').innerHTML = `
                    <tr><td colspan="7" class="py-4 text-center text-red-500">
                        Erro ao carregar os dados: ${error.message}
                    </td></tr>`;
            });
        }
        
        // --- FUNÇÕES DA ABA ESCALAS SALVAS ---

        window.switchView = function(view) {
            currentView = view;
            
            document.getElementById('current-tab').classList.remove('active');
            document.getElementById('saved-tab').classList.remove('active');
            document.getElementById('current-view').classList.add('hidden');
            document.getElementById('saved-view').classList.add('hidden');
            
            if (view === 'current') {
                document.getElementById('current-tab').classList.add('active');
                document.getElementById('current-view').classList.remove('hidden');
                loadSchedule(); // Recarrega os dados de edição
            } else {
                document.getElementById('saved-tab').classList.add('active');
                document.getElementById('saved-view').classList.remove('hidden');
                document.getElementById('archived-scale-display').classList.add('hidden'); // Esconde a visualização ao listar
                loadArchiveList(); // Carrega a lista de arquivos
            }
        }

        function loadArchiveList() {
            if (!db) return;
            const archiveRef = collection(db, getArchiveCollectionPath());
            const q = query(archiveRef); 
            const archiveListDiv = document.getElementById('archive-list');
            archiveListDiv.innerHTML = '<p class="text-gray-500">Carregando lista de escalas salvas...</p>';

            onSnapshot(q, (snapshot) => {
                let archives = [];
                snapshot.forEach(doc => {
                    archives.push({ id: doc.id, ...doc.data() });
                });

                if (archives.length === 0) {
                    archiveListDiv.innerHTML = '<p class="text-gray-500 font-semibold">Nenhuma escala arquivada ainda.</p>';
                    return;
                }
                
                // Ordena por ano e mês para a lista (MM-AAAA)
                archives.sort((a, b) => {
                    const [monthA, yearA] = a.id.split('-').map(Number);
                    const [monthB, yearB] = b.id.split('-').map(Number);
                    if (yearA !== yearB) return yearB - yearA; // Ano decrescente
                    return monthB - monthA; // Mês decrescente
                });

                archiveListDiv.innerHTML = archives.map(archive => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150 border border-gray-200">
                        <span class="text-gray-800 font-medium">${archive.title}</span>
                        <button onclick="viewArchivedScale('${archive.id}')" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition duration-150">
                            Ver Escala
                        </button>
                    </div>
                `).join('');
                
            }, (error) => {
                console.error("Erro ao carregar lista de arquivos:", error);
                archiveListDiv.innerHTML = `<p class="text-red-500">Erro ao carregar arquivos: ${error.message}</p>`;
            });
        }
        
        window.viewArchivedScale = async function(archiveId) {
            if (!db) return;
            const docRef = doc(db, getArchiveCollectionPath(), archiveId);

            try {
                const snapshot = await getDoc(docRef);
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    const title = data.title;
                    const schedule = data.schedule || [];
                    
                    document.getElementById('archived-scale-title').textContent = `${title} (Arquivado em ${new Date(data.archivedAt).toLocaleDateString()})`;
                    
                    // Renderiza a escala arquivada (não-editável)
                    renderTable(schedule, false, 'archived-schedule-body', true);

                    document.getElementById('archived-scale-display').classList.remove('hidden');

                } else {
                    alert('Escala arquivada não encontrada.');
                }
            } catch (error) {
                console.error("Erro ao carregar escala arquivada:", error);
                alert('Erro ao carregar a escala arquivada.');
            }
        }


        /**
         * Envia uma atualização de campo (Portaria, Direção, Preletor) diretamente para o Firestore.
         */
        window.updateFieldInline = async function (docId, field, value) {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor para modificar.");
                // Força o recarregamento para reverter o valor no campo
                loadSchedule(); 
                return;
            }
            if (docId === 'null') {
                console.warn("Item não salvo no Firestore. Por favor, use o botão 'Editar' na linha para salvar o item primeiro.");
                // Força o recarregamento para reverter o valor no campo
                loadSchedule(); 
                return;
            }

            const docRef = doc(db, getCurrentCollectionPath(), docId);
            const updateData = {
                [field]: value,
                lastModifiedBy: auth.currentUser?.email || 'Editor (Email/Senha)',
                timestamp: new Date().getTime() 
            };

            try {
                await setDoc(docRef, updateData, { merge: true });
                console.log(`Documento ${docId} campo ${field} atualizado para ${value}.`);
            } catch (error) {
                console.error("Erro ao atualizar o documento inline:", error);
                loadSchedule(); 
            }
        }
        
        /**
         * Cria o elemento SELECT para edição inline.
         */
        function createNameSelect(docId, fieldName, currentValue, isArchived = false) {
            // Desabilita SE a escala for arquivada OU SE o usuário NÃO for editor
            const isDisabled = isArchived || !isEditor; 
            
            let options = ``;
            const isADefinirSelected = currentValue === 'À DEFINIR' || !currentValue;
            
            options += `<option value="À DEFINIR" ${isADefinirSelected ? 'selected' : ''}>À DEFINIR</option>`;
            
            PREDEFINED_NAMES.forEach(name => {
                const isSelected = name === currentValue ? 'selected' : '';
                options += `<option value="${name}" ${isSelected}>${name}</option>`;
            });
            
            // Se arquivado, retorna apenas o valor estático
            if (isArchived) {
                return `<span class="px-2 py-1 bg-gray-100 rounded text-gray-800 text-sm">${currentValue || 'À DEFINIR'}</span>`;
            }
            
            // Tooltip apenas se não for editor
            const tooltip = !isEditor ? `
                <div class="tooltip-container">
                    <select 
                        class="inline-select opacity-75 bg-gray-100 cursor-default"
                        disabled
                    >
                        ${options}
                    </select>
                    <span class="tooltip-text">Faça login para editar.</span>
                </div>
            ` : `
                <select 
                    class="inline-select ${isDisabled ? 'opacity-75 bg-gray-100 cursor-default' : ''}"
                    onchange="updateFieldInline('${docId}', '${fieldName}', this.value)"
                    ${isDisabled ? 'disabled' : ''}
                >
                    ${options}
                </select>
            `;

            return tooltip;
        }

        function getRowClass(culto, index) {
            const upperCulto = culto.toUpperCase();
            
            if (upperCulto.includes('CULTO DE MISSÕES')) {
                return 'culto-missoes';
            }
            
            const blockIndex = index % 3; 

            if (blockIndex === 0) {
                return 'culto-color-light-grey';
            } else if (blockIndex === 1) {
                return 'culto-color-light-blue';
            } else {
                 return 'culto-color-light-grey';
            }
        }

        function createHeaderRow() {
             const headerRow = document.createElement('tr');
             headerRow.className = 'table-header';
             headerRow.innerHTML = `
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Data</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Dia</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Culto</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Portaria</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Direção</th>
                <th class="px-4 py-3 text-left text-xs uppercase tracking-wider">Preletor</th>
                <th class="px-4 py-3 text-center text-xs uppercase tracking-wider">Ações</th>
            `;
            return headerRow;
        }


        // Renderiza a Tabela
        function renderTable(items, isPlaceholder, targetBodyId, isArchived = false) {
            const tbody = document.getElementById(targetBodyId);
            tbody.innerHTML = '';
            
            if (items.length === 0 && !isPlaceholder) {
                document.getElementById('no-data-message').classList.remove('hidden');
                return;
            }
            if (targetBodyId === 'schedule-body') {
                document.getElementById('no-data-message').classList.add('hidden');
            }
            
            let blockItems = []; // Itens dentro do bloco atual
            
            items.forEach((item, index) => {
                
                // --- INÍCIO DE UM NOVO BLOCO (A cada 3 itens) ---
                if (index % 3 === 0) {
                    blockItems = items.slice(index, index + 3); // Pega os 3 itens (ou menos se for o final)
                    
                    const groupRow = document.createElement('tr');
                    const blockName = getBlockName(index);
                    
                    let blockActions = '';
                    if (!isArchived && isEditor) {
                         const blockActionAdd = `addNewCultoToBlock(${index})`;
                         const blockActionRemove = `showConfirmBlockModal(${JSON.stringify(blockItems)})`;
                         
                         // Verifica se todos os itens do bloco SÃO placeholders
                         const isFullPlaceholder = blockItems.every(i => i.id === 'null');
                         
                         // Se for full placeholder, não mostra a ação de remover bloco
                         if (!isFullPlaceholder) {
                             blockActions += `
                                <svg onclick="${blockActionRemove}" title="Remover Bloco" 
                                    xmlns="http://www.w3.org/2000/svg" class="block-action-icon remove w-5 h-5 ml-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 6l-12 12M6 6l12 12"/>
                                </svg>
                             `;
                         }
                         
                         blockActions += `
                            <svg onclick="${blockActionAdd}" title="Adicionar Novo Culto (Item)" 
                                xmlns="http://www.w3.org/2000/svg" class="block-action-icon add w-5 h-5 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5v14"/>
                            </svg>
                         `;
                    } else if (isArchived) {
                         blockActions = `<span class="text-xs text-gray-500 font-normal">Arquivado</span>`;
                    }


                    groupRow.innerHTML = `
                        <td colspan="7" class="week-divider px-4 py-2 border-t border-b border-indigo-200">
                            <div class="flex justify-between items-center w-full">
                                <div class="w-1/3"></div> <!-- Placeholder para empurrar o título -->
                                <span class="flex-grow text-center">${isArchived ? item.title || blockName : blockName}</span>
                                <div class="flex items-center w-1/3 justify-end">
                                    ${blockActions}
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(groupRow);
                    tbody.appendChild(createHeaderRow()); // Cabeçalho repetido
                }

                const row = document.createElement('tr');
                const rowClass = getRowClass(item.culto, index);
                row.className = `${rowClass} hover:opacity-80 transition duration-150`;
                const textColorClass = 'text-gray-900';
                
                const currentDocId = item.id || 'null'; // Use 'null' string para placeholders

                // --- BOTÕES DE AÇÃO ---
                let actionButtons = '';
                if (isArchived) {
                    actionButtons = `<span class="text-gray-400">Versão Salva</span>`;
                } else if (isEditor) {
                    // Botão para editar Data/Dia/Culto (abre modal)
                    const editButtonAction = `openModal('${currentDocId}', '${item.date}', '${item.day}', '${item.culto}', '${item.portaria}', '${item.direcao}', '${item.preletor}')`;
                    
                    // Mostra "Editar" ou "Excluir" apenas para itens JÁ SALVOS
                    if (item.id !== 'null') {
                        actionButtons += `<button onclick="${editButtonAction}"
                                class="font-semibold focus:outline-none text-indigo-600 hover:text-indigo-900"
                                title="Editar Data, Dia e Culto">
                            Editar
                        </button>`;
                        
                        actionButtons += `<button onclick="showConfirmModal('${item.id}')"
                                class="font-semibold focus:outline-none text-red-600 hover:text-red-900 ml-2"
                                title="Excluir item da escala">
                            Excluir
                        </button>`;
                    } else {
                        // Para placeholders, o botão de adicionar está no bloco, não na linha.
                        actionButtons = `<span class="text-gray-400"></span>`;
                    }
                } else {
                    actionButtons = `<span class="text-gray-400"></span>`; // Remove o texto "Visualizar"
                }
                
                const cultoTextColorClass = 'text-indigo-700';
                
                const portariaContent = createNameSelect(currentDocId, 'portaria', item.portaria, isArchived);
                const direcaoContent = createNameSelect(currentDocId, 'direcao', item.direcao, isArchived);
                const preletorContent = createNameSelect(currentDocId, 'preletor', item.preletor, isArchived);

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${textColorClass}">${item.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${textColorClass}">${item.day}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm culto-cell font-bold ${cultoTextColorClass}">${item.culto}</td>
                    
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${portariaContent}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${direcaoContent}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${preletorContent}</td>
                    
                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium space-x-2">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- Funções de Modal e CRUD ---
        window.openModal = function (docId = 'null', date = '', day = 'DOMINGO', culto = '', portaria = 'À DEFINIR', direcao = 'À DEFINIR', preletor = 'À DEFINIR') {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor.");
                return;
            }
            const modal = document.getElementById('entry-modal');
            const title = document.getElementById('modal-title');
            const saveButton = document.getElementById('save-item-button');
            
            document.getElementById('entry-id').value = docId === 'null' ? '' : docId;
            document.getElementById('date-input').value = date;
            document.getElementById('day-input').value = day;
            document.getElementById('culto-input').value = culto;
            
            // Note: Esses campos hidden só são usados para garantir que os valores "À DEFINIR" sejam passados,
            // mas a edição real de nomes é feita inline.
            document.getElementById('portaria-input').value = portaria;
            document.getElementById('direcao-input').value = direcao;
            document.getElementById('preletor-input').value = preletor;

            if (docId !== 'null' && docId !== '') {
                title.textContent = 'Editar Data/Culto (Nomes: Edição Direta)';
                saveButton.textContent = 'Atualizar Data/Culto';
            } else {
                title.textContent = 'Adicionar Novo Item na Escala';
                saveButton.textContent = 'Salvar Novo Item';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden'; 
        };

        window.closeModal = function () {
            const modal = document.getElementById('entry-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            document.getElementById('entry-form').reset();
        };

        document.getElementById('entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor para modificar.");
                return;
            }
            
            const docId = document.getElementById('entry-id').value;
            const date = document.getElementById('date-input').value.trim();
            const day = document.getElementById('day-input').value.trim();
            const culto = document.getElementById('culto-input').value.trim();
            
            // Pega os valores atuais, que são "À DEFINIR" se não vierem de um item existente
            const portaria = document.getElementById('portaria-input').value.trim();
            const direcao = document.getElementById('direcao-input').value.trim();
            const preletor = document.getElementById('preletor-input').value.trim();

            if (!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
                console.error("Erro de validação: Por favor, use o formato de data DD/MM/AAAA.");
                return;
            }

            const newEntry = {
                date: date,
                day: day,
                culto: culto,
                portaria: portaria, 
                direcao: direcao,
                preletor: preletor,
                timestamp: new Date().getTime(), 
                lastModifiedBy: auth.currentUser?.email || 'Editor (Email/Senha)',
            };
            
            closeModal(); 

            try {
                if (docId) {
                    const docRef = doc(db, getCurrentCollectionPath(), docId);
                    await setDoc(docRef, newEntry, { merge: true }); 
                    console.log("Documento atualizado com sucesso:", docId);
                } else {
                    await addDoc(collection(db, getCurrentCollectionPath()), newEntry);
                    console.log("Novo documento adicionado com sucesso.");
                }
            } catch (error) {
                console.error("Erro ao salvar o documento:", error);
            }
        });
        
        // Funções para o Modal de Confirmação (Exclusão)
        let docIdToDelete = null;

        window.showConfirmModal = function(id) {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor.");
                return;
            }
            docIdToDelete = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        };

        window.hideConfirmModal = function() {
            docIdToDelete = null;
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
            document.body.style.overflow = '';
        };

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!isEditor) {
                console.error("Permissão negada. É necessário estar logado como Editor.");
                hideConfirmModal();
                return;
            }

            if (docIdToDelete && db) {
                try {
                    await deleteDoc(doc(db, getCurrentCollectionPath(), docIdToDelete));
                    console.log("Documento excluído com sucesso:", docIdToDelete);
                } catch (error) {
                    console.error("Erro ao excluir o documento:", error);
                }
            }
            hideConfirmModal();
        });


        // Inicia a aplicação no carregamento da janela
        window.onload = setupFirebase;
    </script>
</body>
</html>
